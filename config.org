#+title: Doom Emacs Config
#+author: John Dovern
#+property: header-args :tangle config.el :mkdirp yes
#+startup:
#+options: ^:{} author:nil title:nill

* Table of Contents :toc:
- [[#general-notes][General Notes]]
- [[#packages][Packages]]
  - [[#org][Org]]
  - [[#zen][Zen]]
  - [[#centered-cursor-mode][Centered Cursor Mode]]
  - [[#wks-mode][WKS Mode]]
  - [[#avy][Avy]]
  - [[#switch-window][Switch Window]]
- [[#settings][Settings]]
  - [[#auto-revert][Auto revert]]
  - [[#cc-configuration][C/C++ configuration]]
  - [[#nix-configuration][Nix configuration]]
  - [[#lua-configuration][Lua configuration]]
  - [[#ocaml-configuration][OCaml configuration]]
  - [[#compilation][Compilation]]
  - [[#spell-fu][Spell-Fu]]
  - [[#yaml][YAML]]
  - [[#tramp][TRAMP]]
  - [[#corfu][Corfu]]
  - [[#cape][Cape]]
  - [[#lsp][LSP]]
  - [[#flycheck][Flycheck]]
  - [[#org-roam][Org-Roam]]
  - [[#evil][Evil]]
  - [[#indent-bars][Indent-Bars]]
  - [[#look-and-feel][Look and Feel]]
  - [[#vterm][Vterm]]
  - [[#leader-key][Leader key]]
  - [[#popups][Popups]]
  - [[#buffers][Buffers]]
  - [[#ibuffer][Ibuffer]]
  - [[#dired-and-dirvish][Dired and Dirvish]]
  - [[#registers][Registers]]
  - [[#projectile][Projectile]]
  - [[#eshell][Eshell]]
  - [[#windows][Windows]]
  - [[#editing][Editing]]
  - [[#workspaces][Workspaces]]
  - [[#quitsession][Quit/Session]]
  - [[#toggle][Toggle]]
  - [[#help-remaps][Help Remaps]]
  - [[#man][Man]]
  - [[#disable-cursor-nudging-in-terminal-buffers][Disable cursor nudging in terminal buffers]]
  - [[#advice][Advice]]
  - [[#debugger][Debugger]]
  - [[#fixes][Fixes]]
  - [[#misc][Misc.]]
- [[#retired][Retired]]
  - [[#functions][Functions]]
  - [[#gptel][GPTEL]]
  - [[#hyprlang][Hyprlang]]
  - [[#cc-configuration-old---for-testing][C/C++ configuration (OLD - for testing)]]
  - [[#javascript-configuration][Javascript configuration]]
  - [[#tree-sitter][Tree-sitter]]
  - [[#word-wrapp][Word wrapp]]
  - [[#smartparens][Smartparens]]

* General Notes

This config uses ',' as the leader key and 'SPC' as the
local leader. Now on with the show!

#+begin_src emacs-lisp
;;; config.el -*- lexical-binding: t; -*-
;; Load custom utility functions
(load! "funcs")
#+end_src

* Packages

** Org

*** Maps

#+begin_src emacs-lisp
(map! :after org
      :leader
      :desc "Find node" "f n" #'org-roam-node-find
      "n l" nil
      (:prefix ("n" . "notes")
               (:prefix ("l" . "links")
                :desc "Yank link"  "y" #'org-store-link
                :desc "Paste link" "p" #'org-insert-link)))
(map! :after org
      :localleader
      (:prefix ("l" . "links")
               (:prefix ("r" . "references")
                :desc "URL"          "u" #'+my/org-insert-link-from-clipboard
                :desc "ID"           "i" #'+my/org-add-id-link
                :desc "ID +desc"     "I" #'+my/org-add-id-link-desc
                :desc "Header"       "h" #'+my/org-add-header-link
                :desc "Header +desc" "H" #'+my/org-add-header-link-desc))
      (:prefix ("H" . "Help")
       :desc "Org Entities" "e" #'org-entities-help)
      (:prefix ("SPC" . "mine")
               (:prefix ("t" . "toggle")
                :desc "Pretty entities" "p" #'org-toggle-pretty-entities)
               :desc "LaTeX" "l" #'org-latex-preview))
#+end_src

*** Looks

#+begin_src emacs-lisp
(defvar cb/pdf-viewer "sioyek"
  "The PDF viewer to use.")
(defvar cb/pdf-viewer-page-argument "--page"
  "Argument for specifying the page number to the pdf viewer")
(defvar cb/pdf-viewer-extra-arguments (list "--new-window")
  "Extra arguments to pass the the pdf viewer")
(defvar cb/pdf-directories '("~/documents/books/")
  "List of directories to search for PDF files.")
(defvar cb/pdf-files-cache nil
  "Cache of PDF files found in `cb/pdf-directories`.")
(after! org
  (org-link-set-parameters "pdf" :follow #'+my/org-pdf-link-follow)
  (add-to-list 'org-modules 'ol-info)
  (setq! org-hide-emphasis-markers t
         org-startup-with-inline-images t
         org-indent-indentation-per-level 1
         org-format-latex-options (plist-put org-format-latex-options :scale 2.0)))
#+end_src

*** Auto Tangle

#+begin_src emacs-lisp
(use-package! org-auto-tangle
  :defer t
  :hook (org-mode . org-auto-tangle-mode)
  :config
  (setq! org-auto-tangle-default t))
#+end_src

** Zen

#+begin_src emacs-lisp
(after! (mixed-pitch writeroom-mode)
  (setq! +zen-text-scale 1))
#+end_src

** Centered Cursor Mode

#+begin_src emacs-lisp
(use-package! centered-cursor-mode
  :hook ((prog-mode text-mode conf-mode) . centered-cursor-mode))
;; (after! centered-cursor-mode
;;   (add-hook! (prog-mode text-mode conf-mode)
;;              :append #'centered-cursor-mode))
#+end_src

** WKS Mode

#+begin_src emacs-lisp
(after! wks-mode
  (sp-local-pair 'wks-mode "<" ">"))
#+end_src

** Avy

#+begin_src emacs-lisp
(after! avy
  (setq! avy-keys '(?a ?r ?s ?t ?n ?e ?i ?o ?g ?m)))
#+end_src

** Switch Window

#+begin_src emacs-lisp
(map! :leader
      "s w" #'switch-window)
(after! switch-window
  (setq! switch-window-qwerty-shortcuts
         '("a" "r" "s" "t"
           "n" "e" "i" "o"
           "g" "m" "x" "c"
           "d" "." "," "h")))
#+end_src

* Settings

** Auto revert

See docs [[info:emacs#Auto Revert][here]]

#+begin_src emacs-lisp
(global-auto-revert-mode 1)
(setq! global-auto-revert-non-file-buffers t)
#+end_src

** C/C++ configuration
Some retarded settings for C/C++ mode. See [[my-c++-mode-hook]]
for more info.

#+begin_src emacs-lisp
(add-hook! '(c-mode-common-hook c-ts-mode-hook c++-ts-mode-hook)
  (modify-syntax-entry ?_ "w"))
(add-hook! '(c-ts-mode-hook c++-ts-mode-hook)
           (setq-local indent-bars-spacing 4)
           (setq! c-ts-mode-indent-offset 4
                  c-ts-mode-indent-style 'bsd))
#+end_src

** Nix configuration

#+begin_src emacs-lisp
(add-hook! '(nix-mode-hook nix-ts-mode-hook)
  (setq-local indent-bars-spacing 2)
  (setq-local tab-width 2))
#+end_src

** Lua configuration

#+begin_src emacs-lisp
;; lsp-mode specific (only runs if lsp-mode is active)
(after! lsp-mode
  (setq lsp-clients-lua-language-server-bin (executable-find "lua-language-server")))

;; eglot specific (only runs if eglot is active)
(after! eglot
  (set-eglot-client! 'lua-mode '("lua-language-server")))

(add-hook! '(lua-mode-hook lua-ts-mode-hook)
  (setq-local corfu-auto-delay 0.2
              lua-indent-level 4
              lua-indent-nested-block-content-align nil))
#+end_src

** OCaml configuration

#+begin_src emacs-lisp
;; (defun +ocaml/comment-indent-new-multi-line (&optional _)
;;   "Break line at point and indent, continuing comment if within one."
;;   (interactive)
;;   (comment-indent-new-line)
;;   (when (eq (char-before) ?*)
;;     (just-one-space))
;;   (unless (eq (char-after) 32)
;;     (save-excursion (insert " ")))
;;   (beginning-of-line)
;;   (skip-chars-forward " \t")
;;   (when (looking-at "\\*+ *")
;;     (replace-match (or comment-continue "")))
;;   (when (eq (char-after) ?*)
;;     (save-excursion (insert " "))))
;; (after! tuareg
;;   (setq-hook! 'tuareg-mode-hook
;;     comment-line-break-function #'+ocaml/comment-indent-new-line))
(defadvice! my/ocaml-comment-indent-new-multi-line (&rest _)
  :after #'+ocaml/comment-indent-new-line
  (beginning-of-line)
  (skip-chars-forward " \t")
  (when (looking-at "\\*+ *")
    (replace-match (or comment-continue "")))
  (when (eq (char-after) ?*)
    (save-excursion (insert " "))))
(add-hook! 'tuareg-mode-hook
  (setq-local compile-command "dune build ")
  (add-hook 'completion-at-point-functions #'cape-keyword 15 t)
  (smartparens-mode -1)
  (electric-pair-local-mode 1)
  (setq-local comment-style 'multi-line)
  (setq-local comment-continue "   ")
  (setq tuareg-electric-indent t)
  (setq tuareg-mode-name "üê´"))
(after! smartparens-ml
  (sp-with-modes '(tuareg-mode)
    (sp-local-pair "sig" nil :actions nil)
    (sp-local-pair "struct" nil :actions nil)
    (sp-local-pair "(*" nil :actions nil)))
(setq! +doom-dashboard-pwd-policy "~/"
       fancy-splash-image "~/.config/doom/doom-emacs-dash.png")
#+end_src

** Compilation

#+begin_src emacs-lisp
(add-hook! compilation-start-hook
  (defun +my/compilation-start-select (proc)
    (when-let ((win (get-buffer-window (process-buffer proc))))
      (select-window win))))
#+end_src

** Spell-Fu

#+begin_src emacs-lisp
(after! spell-fu
  ;; TODO workround for https://github.com/doomemacs/doomemacs/issues/6246
  (unless ispell-dictionary
    (setq! ispell-dictionary "en"))
  (unless (file-exists-p ispell-personal-dictionary)
    (make-directory (file-name-directory ispell-personal-dictionary) t)
    (with-temp-file ispell-personal-dictionary
      (insert (format "personal_ws-1.1 %s 0\n" ispell-dictionary)))))
#+end_src

** YAML

#+begin_src emacs-lisp
(add-hook! yaml-mode
  (spell-fu-mode -1))
#+end_src

** TRAMP

#+begin_src emacs-lisp
(add-hook! tramp-mode
  (setq-local tramp-terminal-type "tramp"))
#+end_src

** Corfu

#+begin_src emacs-lisp
(add-hook! '(prog-mode-hook
             text-mode-hook
             conf-mode-hook
             comint-mode-hook
             minibuffer-setup-hook
             eshell-mode-hook)
           #'+corfu-add-cape-file-h)
(after! corfu
  (setq! corfu-preselect 'prompt
         +corfu-want-ret-to-confirm t
         corfu-quit-at-boundary 'separator
         corfu-auto-prefix 2
         corfu-quit-no-match 'separator
         +corfu-want-tab-prefer-navigating-snippets nil
         +corfu-want-minibuffer-completion nil
         corfu-preview-current 'insert
         corfu-auto-delay 0.2))
(map! :after corfu
      :map corfu-map
      "S-SPC" #'corfu-insert-separator
      "C-l" #'corfu-expand
      "C-g" #'corfu-quit)
#+end_src

** Cape

#+begin_src emacs-lisp
(map! :after cape
      (:prefix ("C-x c" . "cape")
       :desc "cape-file" :i "f" #'cape-file
       :desc "cape-dict" :i "d" #'cape-dict
       :desc "cape-dabbrev" :i "b" #'cape-dabbrev)
      :i "C-/" #'cape-file)
#+end_src

** LSP

*** lsp-mode Configuration (disabled)
:PROPERTIES:
:header-args: :tangle no
:END:

#+begin_src emacs-lisp :tangle no
(after! lsp-mode
  ;; Disable auto-download of language servers (incompatible with NixOS)
  (setq! lsp-enable-suggest-server-download nil
         lsp-format-buffer-on-save t
         lsp-signature-render-documentation nil
         lsp-signature-doc-lines 5
         ;; Performance tuning
         gc-cons-threshold 100000000              ; 100MB (reduces GC pauses)
         read-process-output-max (* 1024 1024)    ; 1MB (faster LSP communication)
         lsp-idle-delay 0.500                      ; Delay before updating
         lsp-log-io nil))                          ; Disable IO logging
#+end_src

*** eglot Configuration (active)

#+begin_src emacs-lisp
(after! eglot
  ;; Performance tuning (equivalent to lsp-mode settings)
  (setq gc-cons-threshold 100000000              ; 100MB
        read-process-output-max (* 1024 1024))   ; 1MB
  ;; Disable events buffer (major performance improvement, like lsp-log-io nil)
  (setq eglot-events-buffer-config '(:size 0))
  ;; ElDoc configuration (equivalent to lsp-signature-doc-lines)
  (setq eldoc-echo-area-use-multiline-p nil))
(after! eglot
  (setq eglot-ignored-server-capabilities '(:documentOnTypeFormattingProvider)))
(add-hook! 'eglot-managed-mode-hook
  (add-hook! 'before-save-hook :local
             #'eglot-format-buffer))
#+end_src

** Flycheck

#+begin_src emacs-lisp
(after! flycheck
  (setq flycheck-display-errors-delay 1.0))
#+end_src

** Org-Roam

#+begin_src emacs-lisp
(after! org-roam
  (setq! org-roam-directory "~/ewiki"
         org-roam-completion-everywhere nil
         org-roam-capture-templates
         '(("d" "default" plain "%?"
            :target (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n")
            :unnarrowed t))))
(defun my/org-writing-mode-setup ()
  "Configure writing-friendly settings"
  (auto-fill-mode 1)
  (setq-local fill-column 60)
  (spell-fu-mode -1))
(add-hook! '(org-mode-hook org-roam-mode-hook gfm-mode-hook markdown-mode-hook)
           #'my/org-writing-mode-setup)
#+end_src

** Evil

#+begin_src emacs-lisp
(evil-global-set-key 'insert (kbd "M-v") 'evil-paste-before)
(global-set-key (kbd "C-z") nil)
(setq! evil-vsplit-window-right t
       evil-split-window-below t)
(map! (:leader
       "h" nil
       :desc "Help" "H" help-map
       "h" #'evil-window-left
       "j" #'evil-window-down
       "k" #'evil-window-up
       "l" #'evil-window-right)
      (:map evil-normal-state-map
            "C-z"     nil
            "Z Z" #'doom/save-and-kill-buffer
            "Z Q" #'kill-current-buffer
            "g b" #'evil-jump-backward
            "q q" #'evil-fill-and-move
            "Q"   #'evil-fill-and-move)
      (:map evil-motion-state-map
            "?" #'+default/search-buffer)
      :im "C-z" nil
      :im "C-f" #'evil-snipe-f
      :im "C-S-f" #'evil-snipe-F)
#+end_src

** Indent-Bars

#+begin_src emacs-lisp
(defun +my/indent-bars-enable-h ()
  "Enable indent-bars-mode unless in a posframe or special buffer."
  (unless (string-prefix-p " *" (buffer-name))
    (indent-bars-mode 1)))
(add-hook! (prog-mode text-mode conf-mode)
  :append #'+my/indent-bars-enable-h)
#+end_src

** Look and Feel

#+begin_src emacs-lisp
(setq! doom-theme 'doom-kanagawa-abyss
       doom-font (font-spec :font "Monospace" :size 16.0)
       doom-big-font (font-spec :font "Monospace" :size 36.0)
       doom-variable-pitch-font (font-spec :font "Sans" :size 16.0)
       doom-symbol-font (font-spec :font "Monospace" :size 16.0)
       doom-serif-font (font-spec :font "Serif" :size 16.0)
       doom-themes-enable-bold t
       doom-themes-enable-italic t
       doom-kanagawa-abyss-brighter-comments t
       doom-kanagawa-abyss-red-cursor t
       doom-kanagawa-abyss-match-org-blocks t
       doom-kanagawa-dragon-match-org-blocks t
       doom-kanagawa-lotus-match-org-blocks t
       doom-kanagawa-wave-match-org-blocks t
       display-line-numbers-type nil
       doom-modeline-height 25
       doom-modeline-bar-width 5
       doom-modeline-persp-name t
       doom-modeline-persp-icon t)
(set-face-attribute 'mode-line nil :font "Monospace")
(map! :leader
      :desc "Load new theme" "H t" #'consult-theme)
(setq max-mini-window-height 1)
#+end_src

** Vterm

#+begin_src emacs-lisp
(map! (:leader
       :desc "Vterm popup toggle" "t t" #'+vterm/toggle
       :desc "Open vterm" "t v" #'+vterm/here)
      :map vterm-mode-map
      :i "<S-return>" #'+my/vterm-send-shift-enter)
(after! vterm
  (setq! vterm-max-scrollback 100000))
;; Insert when switching to vterm buffer
;; (add-hook! doom-switch-buffer
;;   (when (eq major-mode 'vterm-mode)
;;     (evil-collection-vterm-insert)))
#+end_src

** Leader key

#+begin_src emacs-lisp
(setq! doom-leader-key ","
       doom-leader-alt-key "M-,"
       doom-localleader-key "SPC"
       doom-localleader-alt-key "M-SPC")
#+end_src

** Popups

#+begin_src emacs-lisp
;; (set-popup-rule! "^\\*\\(?:[Cc]ompil\\(?:ation\\|e-Log\\)\\)" :ignore t :select t)
(map! :leader
      (:prefix ("w" . "window")
       "p" nil
       (:prefix ("p" . "popup")
        "o" #'+popup/other
        "t" #'+popup/toggle
        "c" #'+popup/close
        "C" #'+popup/close-all
        "R" #'+popup/restore
        "r" #'+popup/raise)))
(set-popup-rule! "^\\*\\(?:[Cc]ompil\\(?:ation\\|e-Log\\)\\)"
  :side 'bottom
  :size 0.3
  :vslot -2
  :quit t
  :select t)
#+end_src

** Buffers

#+begin_src emacs-lisp
(map! :leader
      :desc "Select all" "g a" #'mark-whole-buffer
      (:prefix ("b" . "buffer")
       :desc "Clone buffer other window" "c" #'clone-indirect-buffer-other-window
       :desc "List bookmarks" "L" #'list-bookmarks
       :desc "Save current bookmarks to bookmark file" "w" #'bookmark-save)
       (:prefix ("f" . "file")
        :desc "Rename" "r" #'rename-visited-file))
#+end_src

** Ibuffer

#+begin_src emacs-lisp
(evil-define-key 'normal ibuffer-mode-map
        (kbd "f c") 'ibuffer-filter-by-content
        (kbd "f d") 'ibuffer-filter-by-directory
        (kbd "f f") 'ibuffer-filter-by-filename
        (kbd "f m") 'ibuffer-filter-by-mode
        (kbd "f n") 'ibuffer-filter-by-name
        (kbd "f x") 'ibuffer-filter-disable
        (kbd "g h") 'ibuffer-do-kill-lines
        (kbd "g H") 'ibuffer-update)
#+end_src

** Dired and Dirvish

#+begin_src emacs-lisp
(after! dirvish
  (setq dired-listing-switches "-l --almost-all --human-readable --sort=version --group-directories-first"))
(use-package! dired-open
  :after dired
  :config
  (setq dired-open-extensions
        '(("mkv" . "mpv")
          ("webm" . "mpv")
          ("pdf" . "sioyek --new-window"))))
(add-hook! 'dired-mode-hook (dired-hide-details-mode))
(map! :leader
      (:prefix ("d" . "dired")
       :desc "Dirvish side" "j" #'dirvish-side)
      (:after dired
       (:map dired-mode-map
        :desc "Peep-dired image previews" "d p" #'peep-dired
        :desc "Dired view file" "d v" #'dired-view-file)))
(evil-define-key 'normal peep-dired-mode-map
  (kbd "j") 'peep-dired-next-file
  (kbd "k") 'peep-dired-prev-file)
(add-hook! 'peep-dired-hook #'evil-normalize-keymaps)
(after! (:or dirvish dired)
  (map! :map (dirvish-mode-map dired-mode-map)
        :n "l" #'dired-find-alternate-file))

;; Preserve symlink paths - don't resolve to truenames
(setq find-file-visit-truename nil)
#+end_src

*** File Manager Mode

Launch Emacs as a standalone file manager with =EMACS_FM_MODE=1 emacs -e '(dirvish ".")'=.
In this mode:
- Quitting dirvish (~q~) closes the entire frame
- Closing a file (~ZZ~/~ZQ~) returns to dirvish at that file's directory
- ~O~ opens files in a separate independent frame (normal Emacs behavior)

Shell wrapper function (add to your shell config):
#+begin_src bash :tangle no
emfm() {
    EMACS_FM_MODE=1 emacs --eval "(dirvish \"${1:-.}\")" &
}
#+end_src

#+begin_src emacs-lisp
(defvar cb/file-manager-mode (getenv "EMACS_FM_MODE")
  "When non-nil, Emacs runs in standalone file-manager mode.
Set via EMACS_FM_MODE=1 environment variable before launching Emacs.")

(when cb/file-manager-mode
  ;; Tag frame as file-manager frame when dired opens
  (defun cb/fm-tag-frame-h ()
    "Tag the current frame as a file-manager frame (runs once)."
    (unless (frame-parameter nil 'cb/fm-frame)
      (set-frame-parameter nil 'cb/fm-frame t)))
  (add-hook 'dired-mode-hook #'cb/fm-tag-frame-h)

  ;; Quit dirvish ‚Üí delete the file-manager frame (or exit if sole frame)
  (defadvice! cb/fm-quit-delete-frame-a (&rest _)
    :after #'dirvish-quit
    (when (frame-parameter nil 'cb/fm-frame)
      (if (> (length (frame-list)) 1)
          (delete-frame)
        (save-buffers-kill-emacs))))

  (defun cb/fm-save-and-return-to-dirvish ()
    "Save buffer, kill it, and return to dirvish at file's directory.
In non-FM frames, falls back to `doom/save-and-kill-buffer'."
    (interactive)
    (if (not (frame-parameter nil 'cb/fm-frame))
        (doom/save-and-kill-buffer)
      (let ((dir (if buffer-file-name
                     (file-name-directory buffer-file-name)
                   default-directory)))
        (when (and buffer-file-name (buffer-modified-p))
          (save-buffer))
        (kill-current-buffer)
        (dirvish dir))))

  (defun cb/fm-return-to-dirvish ()
    "Kill buffer (prompting if modified) and return to dirvish at file's directory.
In non-FM frames, falls back to `kill-current-buffer'."
    (interactive)
    (if (not (frame-parameter nil 'cb/fm-frame))
        (kill-current-buffer)
      (let ((dir (if buffer-file-name
                     (file-name-directory buffer-file-name)
                   default-directory)))
        (kill-current-buffer)
        (dirvish dir))))

  ;; Keybindings
  (map! :after dired
        :map dired-mode-map
        :n "O" #'find-file-other-frame)

  (map! :n "Z Z" #'cb/fm-save-and-return-to-dirvish
        :n "Z Q" #'cb/fm-return-to-dirvish))
#+end_src

** Registers

#+begin_src emacs-lisp
(map! :leader
      (:prefix ("r" . "registers")
       :desc "Copy to register" "c" #'copy-to-register
       :desc "Frameset to register" "f" #'frameset-to-register
       :desc "Insert contents of register" "i" #'insert-register
       :desc "Jump to register" "j" #'jump-to-register
       :desc "List registers" "l" #'list-registers
       :desc "Number to register" "n" #'number-to-register
       :desc "Interactively choose a register" "r" #'counsel-register
       :desc "View a register" "v" #'view-register
       :desc "Window configuration to register" "w" #'window-configuration-to-register
       :desc "Increment register" "+" #'increment-register
       :desc "Point to register" "SPC" #'point-to-register))
#+end_src

** Projectile

#+begin_src emacs-lisp
(map! :after projectile
      :leader
      "," nil
      "." nil
      "<" nil
      :desc "Switch project buffer" "," #'projectile-switch-to-buffer
      :desc "Find project file" "." #'projectile-find-file
      :desc "Find file" ">" #'find-file
      :desc "Consult project buffer" "<" #'consult-buffer)
(after! projectile
  (setq! projectile-buffers-filter-function #'projectile-buffers-with-file-or-process
         projectile-enable-caching t
         projectile-files-cache-expire 60)
  ;; Ignore NixOS and build directories
  (add-to-list 'projectile-globally-ignored-directories ".direnv")
  (add-to-list 'projectile-globally-ignored-directories "result")
  (add-to-list 'projectile-globally-ignored-directories "target"))

;; Auto-refresh cache on file changes within Emacs
(add-hook! 'after-save-hook
  (when (projectile-project-p)
    (projectile-invalidate-cache nil)))

(add-hook! 'delete-file-hook
  (when (projectile-project-p)
    (projectile-invalidate-cache nil)))
#+end_src

** Eshell

#+begin_src emacs-lisp
(map! :leader
      (:prefix ("e" . "Eshell")
       :desc "Eshell" "e s" #'eshell
       :desc "Counsel eshell history" "e h" #'counsel-esh-history))
#+end_src

** Windows

#+begin_src emacs-lisp
(map! :leader
      :desc "Shrink height" "_" (cmd! (evil-window-set-height 20))
      (:prefix ("w" . "window")
       :desc "Window enlargen" "i" #'doom/window-enlargen
       :desc "balance windows" "y" #'balance-windows
       :desc "Winner redo" "<right>" #'winner-redo
       :desc "Winner undo" "<left>" #'winner-undo))
#+end_src

** Editing

#+begin_src emacs-lisp
(map! :leader
      :desc "Zap to char" "z" #'zap-to-char
      :desc "Zap up to char" "Z" #'zap-up-to-char)
#+end_src

** Workspaces

#+begin_src emacs-lisp
(map! :leader
      (:prefix ("TAB" . "workspace")
       :desc "Workspace Left"         "h" #'+workspace/switch-left
       :desc "Workspace Right"         "l" #'+workspace/switch-right
       "s" nil
       (:prefix ("s" . "switch")
        :desc "Switch to 1st workspace" "a" #'+workspace/switch-to-0
        :desc "Switch to 2nd workspace" "r" #'+workspace/switch-to-1
        :desc "Switch to 3rd workspace" "s" #'+workspace/switch-to-2
        :desc "Switch to 4th workspace" "t" #'+workspace/switch-to-3
        :desc "Switch to 5th workspace" "n" #'+workspace/switch-to-4
        :desc "Switch to 6th workspace" "e" #'+workspace/switch-to-5
        :desc "Switch to 7th workspace" "i" #'+workspace/switch-to-6
        :desc "Switch to 8th workspace" "o" #'+workspace/switch-to-7)
       :desc "Save to workspace file"     "S"   #'+workspace/save
       :desc "Switch to last workspace"   "TAB" #'+workspace/other
       :desc "Display tab bar"            "."   #'+workspace/display
       :desc "List workspaces"            "o"   #'+workspace/switch-to))
#+end_src

** Quit/Session

#+begin_src emacs-lisp
(map! :leader
      (:prefix ("q" . "quit/session")
       :desc "Quit Emacs"   "e" #'save-buffers-kill-terminal
       :desc "Delete frame" "q" #'save-buffers-kill-emacs))
#+end_src

** Toggle

#+begin_src emacs-lisp
(map! :leader
      (:prefix ("t" . "toggle")
       :desc "Toggle line numbers" "L" #'doom/toggle-line-numbers
       :desc "Restart LSP server"  "l" (cmd! (if (bound-and-true-p eglot--managed-mode)
                                                  (eglot-reconnect (eglot-current-server))
                                                (lsp-workspace-restart (lsp-workspaces))))))
#+end_src

** Help Remaps

#+begin_src emacs-lisp
(map! :leader
      "v" #'helpful-variable
      "F" #'helpful-callable
      "K" #'helpful-key)
#+end_src

** Man

#+begin_src emacs-lisp
(map! :leader
      "o m" #'man)
#+end_src

** Disable cursor nudging in terminal buffers

Terminal emulators and shells work better without centered-cursor-mode.
Small scroll margins are kept for context, and =scroll-conservatively= is set
high (101+) to ensure the buffer scrolls one line at a time instead of
recentering with jarring half-page jumps.

#+begin_src emacs-lisp
(defun my/disable-cursor-nudging-h ()
  "Disable centered-cursor-mode in current buffer with minimal scroll margins.
This is useful for terminal emulators and shell buffers where
cursor centering interferes with the natural scrolling behavior.
Uses scroll-conservatively 101 to scroll one line at a time."
  (centered-cursor-mode -1)
  (setq-local scroll-margin 2
              hscroll-margin 2
              scroll-conservatively 101
              maximum-scroll-margin 0.1))
(add-hook! '(vterm-mode-hook
             eshell-mode-hook
             shell-mode-hook
             term-mode-hook
             comint-mode-hook)
           #'my/disable-cursor-nudging-h)
#+end_src

** Advice

*** My/Prompt-For-Buffer-After-Split

#+begin_src emacs-lisp
;; (defadvice! prompt-for-buffer (&rest _)
;;   :after '(evil-window-split evil-window-vsplit)
;;   (consult-buffer))
(defadvice! my/prompt-for-buffer-after-split (&rest _)
  :after '(evil-window-split evil-window-vsplit)
  ;; Only prompt when called interactively by the user
  (when (and (called-interactively-p 'interactive)
             (fboundp 'consult-buffer)
             (not (minibufferp)))
    (condition-case err
        (consult-buffer)
      (quit (message "Buffer selection cancelled"))
      (error (message "Failed to prompt: %s" err)))))
#+end_src

#+begin_src emacs-lisp
(map! :leader
      "x" nil
      :desc "Execute" "x" #'execute-extended-command)
#+end_src

** Debugger

#+begin_src emacs-lisp
(map! :map dap-mode-map
      :leader
      "d b" nil
      "d d" nil
      "d e" nil
      "d t" nil
      (:prefix ("d" . "dap")
       ;; basics
       :desc "dap next"          "n" #'dap-next
       :desc "dap step in"       "i" #'dap-step-in
       :desc "dap step out"      "o" #'dap-step-out
       :desc "dap continue"      "c" #'dap-continue
       :desc "dap hydra"         "h" #'dap-hydra
       :desc "dap debug restart" "r" #'dap-debug-restart
       :desc "dap debug"         "s" #'dap-debug
       ;; debug
       (:prefix ("d" . "Debug")
        :desc "dap debug recent"  "r" #'dap-debug-recent
        :desc "dap debug last"    "l" #'dap-debug-last)
       ;; eval
       (:prefix ("e" . "Eval")
        :desc "eval"                "e" #'dap-eval
        :desc "eval region"         "r" #'dap-eval-region
        :desc "eval thing at point" "s" #'dap-eval-thing-at-point
        :desc "add expression"      "a" #'dap-ui-expressions-add
        :desc "remove expression"   "d" #'dap-ui-expressions-remove)
       ;; breakpoint
       (:prefix ("b" . "Breakpoint")
        :desc "dap breakpoint toggle"      "b" #'dap-breakpoint-toggle
        :desc "dap breakpoint condition"   "c" #'dap-breakpoint-condition
        :desc "dap breakpoint hit count"   "h" #'dap-breakpoint-hit-condition
        :desc "dap breakpoint log message" "l" #'dap-breakpoint-log-message)
       ;; debug
       (:prefix ("t" . "Template")
        :desc "dap edit template" "e" #'dap-debug-edit-template)))

;; close dap-output on exit
(after! dap-mode
  (require 'dap-gdb)
  (require 'dap-lldb)
  (require 'dap-cpptools)
  (require 'dap-gdb-lldb))
(add-hook! 'dap-terminated-hook (call-interactively #'hydra-keyboard-quit))
(add-hook! 'dap-stopped-hook (call-interactively #'dap-hydra))
(after! gdb-mi
  (setq! gdb-restore-window-configuration-after-quit t))
(after! dap-mode
  (dap-register-debug-template
   "GDB::Run::hypr::plugin"
   (list :type "gdb"
         :request "launch"
         :name "GDB::Run::hypr::plugin"
         ;; :arguments "test"
         :target "Hyprland"
         :cwd "${workspaceFolder}/build"))
  (dap-register-debug-template
   "GDB::Run::ccss::lexer_test"
   (list :type "gdb"
         :request "launch"
         :name "GDB::Run::ccss::lexer_test"
         ;; :arguments "test"
         :target "tests/lexer_test"
         :cwd "${workspaceFolder}/build"))
  (dap-register-debug-template
   "GDB::Run::ccss::parser_test"
   (list :type "gdb"
         :request "launch"
         :name "GDB::Run::ccss::parser_test"
         ;; :arguments "test"
         :target "tests/parser_test"
         :cwd "${workspaceFolder}/build"))
  (dap-register-debug-template
   "GDB::Run::wk::circular_includes"
   (list :type "gdb"
         :request "launch"
         :name "GDB::Run::wk::circular_includes"
         :arguments "--key-chords tests/fixtures/invalid/circular_include_test.wks"
         :target "./wk"
         :cwd "${workspaceFolder}"))
  (dap-register-debug-template
   "GDB::Run::wk"
   (list :type "gdb"
         :request "launch"
         :name "GDB::Run::wk"
         :arguments "--debug"
         :target "./wk"
         :cwd "${workspaceFolder}"))
  (dap-register-debug-template
   "GDB::Run::wk::main.wks"
   (list :type "gdb"
         :request "launch"
         :name "GDB::Run::wk::main.wks"
         :arguments "--debug --key-chords main.wks"
         :target "./wk"
         :cwd "${workspaceFolder}"))
  (dap-register-debug-template
   "cpptools::Run"
   (list :type "cppdbg"
         :request "launch"
         :name "cpptools::Run"
         :args []
         :MIMode "gdb"
         :program "${workspaceFolder}/"
         :cwd     "${workspaceFolder}"))
  (dap-register-debug-template
   "cpptools::Run::clox::cli"
   (list :type "cppdbg"
         :request "launch"
         :name "cpptools::Run::clox::cli"
         :args []
         :MIMode "gdb"
         :program "${workspaceFolder}/clox"
         :cwd "${workspaceFolder}"))
  (dap-register-debug-template
   "cpptools::Run::clox::script"
   (list :type "cppdbg"
         :request "launch"
         :name "cpptools::Run::clox::script"
         :args ["./script.lox"]
         :MIMode "gdb"
         :program "${workspaceFolder}/clox"
         :cwd "${workspaceFolder}"))
  (dap-register-debug-template
   "cpptools::Run::wk::args"
   (list :type "cppdbg"
         :request "launch"
         :name "cpptools::Run::wk::args"
         :args ["--fg"]
         :MIMode "gdb"
         :program "${workspaceFolder}/wk"
         :cwd "${workspaceFolder}"))
  (dap-register-debug-template
   "cpptools::Run::wk::main.wks"
   (list :type "cppdbg"
         :request "launch"
         :name "cpptools::Run::wk::main.wks"
         :args ["--debug" "--key-chords" "./main.wks"]
         :MIMode "gdb"
         :program "${workspaceFolder}/wk"
         :cwd "${workspaceFolder}"))
  (dap-register-debug-template
   "cpptools::Run::wk::key-chords"
   (list :type "cppdbg"
         :request "launch"
         :name "cpptools::Run::wk::key-chords"
         :args ["--debug" "--key-chords" "./examples/key_chords.wks"]
         :MIMode "gdb"
         :program "${workspaceFolder}/wk"
         :cwd "${workspaceFolder}"))
  (dap-register-debug-template
   "cpptools::Run::wk::chord-array"
   (list :type "cppdbg"
         :request "launch"
         :name "cpptools::Run::wk::chord-array"
         :args ["--debug" "--key-chords" "./examples/chord_array_example.wks"]
         :MIMode "gdb"
         :program "${workspaceFolder}/wk"
         :cwd "${workspaceFolder}"))
  (dap-register-debug-template
   "cpptools::Run::wk::transpile"
   (list :type "cppdbg"
         :request "launch"
         :name "cpptools::Run::wk::transpile"
         :args ["./wk" "--debug" "--transpile" "./examples/key_chords.wks"]
         :MIMode "gdb"
         ;; :program "${workspaceFolder}/wk"
         :program "/usr/bin/valgrind"
         :cwd "${workspaceFolder}"))
  (dap-register-debug-template
   "cpptools::Run::wk::main"
   (list :type "cppdbg"
         :request "launch"
         :name "cpptools::Run::wk::main"
         :args []
         :MIMode "gdb"
         :program "${workspaceFolder}/wk"
         :cwd "${workspaceFolder}")))
#+end_src

** Fixes

*** Disable Emacs decorations (title bar)

#+begin_src emacs-lisp
;; Necessary for river wayland compositor
(setq! default-frame-alist '((undecorated . t)
                             (vertical-scroll-bars . nil)))
#+end_src

*** Smartparens post-handlers for tree-sitter modes

Smartparens' default post-handlers for ={= add extra blank lines in
tree-sitter modes because treesit-indent uses different indentation
logic than traditional CC Mode. This removes the RET post-handler
while keeping space insertion and other smartparens features (comment
pairing, quote pairing, wrapping, navigation).

#+begin_src emacs-lisp
;; (defun +my/fix-smartparens-braces-h ()
;;   "Fix smartparens brace post-handlers for current tree-sitter mode."
;;   (dolist (brace '("{" "[" "("))
;;     (sp-local-pair major-mode brace nil :post-handlers '(("| " "SPC")))))
;; (add-hook! '(c-ts-mode-hook
;;              c++-ts-mode-hook
;;              java-ts-mode-hook
;;              js-ts-mode-hook
;;              rust-ts-mode-hook
;;              zig-ts-mode-hook
;;              python-ts-mode-hook
;;              bash-ts-mode-hook
;;              ;; lua-ts-mode-hook
;;              nix-ts-mode-hook
;;              yaml-ts-mode-hook)
;;            :append #'+my/fix-smartparens-braces-h)
#+end_src

** Misc.

#+begin_src emacs-lisp
(setq! undo-limit 80000000                         ; Raise undo-limit to 80Mb
       auto-save-default t                         ; Nobody likes to lose work, I certainly don't
       scroll-preserve-screen-position 'always     ; Don't have `point' jump around
       hscroll-margin 6                            ; It's nice to maintain a little margin
       scroll-margin 5)
#+end_src

*** Trash files

#+begin_src emacs-lisp
(setq! delete-by-moving-to-trash t
       trash-directory "~/.local/share/Trash/files/")
#+end_src

* Retired
:PROPERTIES:
:header-args: :tangle no
:END:

** Functions

Please see funcs.org for more info

#+begin_src emacs-lisp :tangle no
(load! "funcs.el")
#+end_src

** GPTEL

#+begin_src emacs-lisp :tangle no
; Meta-Llama-3-8B-Instruct.Q4_0.gguf
;; OPTIONAL configuration
;; (setq
;;  gptel-max-tokens 4096
;;  gptel-model "Meta-Llama-3-8B-Instruct.Q4_0.gguf"
;;  gptel-backend (gptel-make-gpt4all "GPT4All"
;;                  :protocol "http"
;;                  :host "localhost:4891"
;;                  :models '("Meta-Llama-3-8B-Instruct.Q4_0.gguf"
;;                            "Nous-Hermes-2-Mistral-7B-DPO.Q4_0.gguf"
;;                            "gpt4all-falcon-newbpe-q4_0.gguf")))
#+end_src

** Hyprlang

#+begin_src emacs-lisp :tangle no
;; (use-package hyprlang-ts-mode
;;   :custom
;;   (hyprlang-ts-mode-indent-offset 4))
#+end_src

** C/C++ configuration (OLD - for testing)
:PROPERTIES:
:header-args: :tangle no
:END:

This is the previous C/C++ configuration from commit d08e718.
To test this configuration instead of the new one above:
1. Change the ~:tangle no~ property above to ~:tangle config.el~
2. Change the ~:tangle config.el~ property in the section above to ~:tangle no~
3. Save and let org-auto-tangle regenerate config.el
4. Restart Emacs or reload config

#+begin_src emacs-lisp :tangle no
;; Common hook for c-mode (applies to both c-mode and c++-mode)
(add-hook! 'c-mode-common-hook
  (modify-syntax-entry ?_ "w"))
(setq c-tab-always-indent nil)

;; Style definition (OLD version with typo and fewer settings)
(defconst my-c++-style-old
  '("bsd"
    (c-basic-offset . 4)
    (c-hanging-braces-alist . ((arglist-close before)))
    (c-offsets-alist . ((namespace-open . 0)
                        (innamespace . 0)
                        (label . -)
                        (access-label . -)
                        (inclass . +)
                        (substatement-label . 0)
                        (case-lable . 0)  ;; NOTE: typo here (lable instead of label)
                        (arglist-intro . +)
                        (arglist-close . 0)))))

;; Hook function (only for c++-mode, not c-mode)
(defun my-c++-mode-hook-old ()
  (c-add-style "my-c++-style" my-c++-style-old)
  (c-set-style "my-c++-style")
  (setq! c-default-style "my-c++-style"
         c-ts-mode-indent-style 'bsd
         lsp-ui-sideline-enable t
         c-basic-offset 4
         c-ts-mode-indent-offset 4
         tab-width 4))

;; Add hook only for c++-mode (c-mode not included)
(add-hook! 'c++-mode-hook 'my-c++-mode-hook-old)

;; Global settings (applied immediately, affects all buffers)
(c-add-style "my-c++-style" my-c++-style-old)
(setq! c-default-style "my-c++-style"
       c-ts-mode-indent-style 'bsd
       lsp-ui-sideline-enable t
       c-basic-offset 4
       c-ts-mode-indent-offset 4
       tab-width 4)

;; LSP-Clangd configuration (same in both versions)
(after! lsp-clangd
  (setq lsp-clients-clangd-args
        '("-j=3"
          "--background-index"
          "--clang-tidy"
          "--completion-style=detailed"
          "--header-insertion=never"
          "--header-insertion-decorators=0"))
  (set-lsp-priority! 'clangd 2))
#+end_src

#+begin_src emacs-lisp :tangle no
(setq! c-tab-always-indent nil)
(defconst my-c++-style
  '("bsd"
    (c-basic-offset . 4)
    (c-hanging-braces-alist . ((substatement-open before)
                               (arglist-close before)))
    (c-offsets-alist . ((namespace-open . 0)
                        (innamespace . 0)
                        (label . -)
                        (access-label . -)
                        (inclass . +)
                        (substatement-label . 0)
                        (case-label . 0)
                        (arglist-intro . +)
                        (arglist-cont . +)
                        (arglist-cont-nonempty . +)
                        (arglist-close . 0)))))
;; Hook for traditional CC Mode (c-mode, c++-mode)
(defun my-c/c++-mode-hook ()
  "Common settings for C and C++ modes (CC Mode only)."
  ;; Register and apply style immediately (buffer-local)
  (c-add-style "my-c++-style" my-c++-style t)
  ;; Other buffer-local settings
  (setq! c-basic-offset 4
         tab-width 4)
  ;; Fix indent-bars spacing
  (when (bound-and-true-p indent-bars-mode)
    (setq! indent-bars-spacing 4)
    (indent-bars-reset)))
(add-hook! '(c-mode-hook c++-mode-hook)
           #'my-c/c++-mode-hook)
(after! lsp-clangd
  (setq! lsp-clients-clangd-args
        '("-j=3"
          "--background-index"
          "--clang-tidy"
          "--completion-style=detailed"
          "--header-insertion=never"
          "--header-insertion-decorators=0"))
  (set-lsp-priority! 'clangd 2))
;; (after! ccls
;;   (setq ccls-initialization-options '(:index (:comments 2) :completion (:detailedLabel t)))
;;   (set-lsp-priority! 'ccls 1))
#+end_src

** Javascript configuration

#+begin_src emacs-lisp :tangle no
(after! rjsx-mode
  (setq! js-indent-level 4))
#+end_src

** Tree-sitter
#+begin_src emacs-lisp :tangle no
;; (add-to-list '+tree-sitter-hl-enabled-modes 'c++-mode t)
;; (after! tree-sitter
;;   (global-tree-sitter-mode)
;;   (setq treesit-language-source-alist
;;       '((cpp "https://github.com/tree-sitter/tree-sitter-cpp")
;;         (c "https://github.com/tree-sitter/tree-sitter-c"))))
;; (setq +tree-sitter-hl-enabled-modes t)
#+end_src

** Word wrapp

#+begin_src emacs-lisp :tangle no
(setq! +word-wrap-extra-indent nil)
#+end_src

** Smartparens

#+begin_src emacs-lisp :tangle no
(after! smartparens
  (show-smartparens-global-mode t)
  ;; Fix closing brace indentation for all modes
  (sp-local-pair 'prog-mode "{" nil
                 :post-handlers '(("||\n[i]" "RET")
                                  ("| " "SPC")))
  (sp-local-pair 'prog-mode "[" nil
                 :post-handlers '(("||\n[i]" "RET")
                                  ("| " "SPC")))
  (sp-local-pair 'prog-mode "(" nil
                 :post-handlers '(("||\n[i]" "RET")
                                  ("| " "SPC"))))
#+end_src

#+begin_src emacs-lisp :tangle no
(setf (alist-get '(markdown-mode org-mode org-roam-mode) +spell-excluded-faces-alist)
      '(markdown-code-face
        markdown-reference-face
        markdown-link-face
        markdown-url-face
        markdown-markup-face
        markdown-html-attr-value-face
        markdown-html-attr-name-face
        markdown-html-tag-name-face))
#+end_src

#+begin_src emacs-lisp :tangle no
(after! treemacs
  (setq! treemacs-width 35
         treemacs-default-visit-action #'treemacs-visit-node-close-treemacs
         treemacs-show-cursor t))
#+end_src

#+begin_src emacs-lisp :tangle no
(custom-set-faces!
  '(font-lock-comment-face :slant italic))
#+end_src

#+begin_src emacs-lisp :tangle no
(xterm-mouse-mode 1)
#+end_src

#+begin_src emacs-lisp :tangle no
(setq eshell-aliases-file "~/.config/doom/eshell/aliases"
      eshell-history-size 5000
      eshell-buffer-maximum-lines 5000
      eshell-hist-ignoredups t
      eshell-scroll-to-bottom-on-input t
      eshell-destroy-buffer-when-process-dies t
      eshell-visual-commands'("bash" "htop" "ssh" "top" "zsh"))
#+end_src

#+begin_src emacs-lisp :tangle no
;; (setq dap-ui-locals-expand-depth t)
;; (setq dap-auto-show-output nil)
;; (add-hook 'dap-terminated-hook
;;           (lambda (arg) (call-interactively #'dap-hydra)))
#+end_src

#+begin_src emacs-lisp :tangle no
(run-after-saving-unix-mode "/bindsrc$" "wkx-update --binds")
(run-after-saving-unix-mode "/keysrc$" "wkx-update --keys")
;; (run-after-saving 'conf-space-mode-hook "/sxhkdrc$" "kill -SIGUSR1 \"$(pidof sxhkd)\"")
#+end_src

#+begin_src emacs-lisp :tangle no
(add-to-list 'auto-mode-alist '("xresources" . conf-mode))
(run-after-saving 'conf-mode-hook "/xresources$"
                  "xrdb \"$HOME/.config/x11/xresources\"")
;; (maybe-run-after-saving 'c-mode-hook "/config\.h$" "dwmup")
;; (add-hook! 'conf-mode-hook
;;   (when (stringp buffer-file-name)
;;     (when (string-match-p "/xresources$" buffer-file-name)
;;       (add-hook! 'after-save-hook :local
;;         (shell-command "xrdb \"$HOME/.config/x11/xresources\"")))))
#+end_src

#+begin_src emacs-lisp :tangle no
(run-after-saving-unix-mode "/dunstrc$" "pkill dunst; systemctl --user restart dunst.service")
;; (add-hook! 'conf-unix-mode-hook
;;   (when (stringp buffer-file-name)
;;       (if (string-match-p "/dunstrc$" buffer-file-name)
;;           (add-hook! 'after-save-hook :local
;;             (shell-command-to-string "systemctl --user restart dunst.service")))))
#+end_src

#+begin_src emacs-lisp :tangle no
(defun prefer-horizontal-split ()
  (set-variable 'split-height-threshold nil t)
  (set-variable 'split-width-threshold 40 t)) ; make this as low as needed
(add-hook! 'markdown-mode-hook 'prefer-horizontal-split)
#+end_src

#+begin_src emacs-lisp :tangle no
(defun toggle-my-theme ()
  "Toggle light and dark themes"
  (interactive)
  (if (eq doom-theme 'doom-one)
      (load-theme 'doom-one-light t)
    (load-theme 'doom-one t)))
#+end_src

#+begin_src emacs-lisp :tangle no
(map! :leader
      :desc "Get files" "c g" (lambda () (interactive) (run-command-in-vterm "grep -R")))
#+end_src
